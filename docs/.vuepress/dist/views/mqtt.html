<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MQTT协议介绍</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.svg">
    <script src="/js/iframeSizer.contentWindow.min.js"></script>
    <meta name="description" content="这是fluxmq的官方文档">
    
    <link rel="preload" href="/assets/css/0.styles.fb29a6e6.css" as="style"><link rel="preload" href="/assets/js/app.3c98569e.js" as="script"><link rel="preload" href="/assets/js/2.6c5bc1d3.js" as="script"><link rel="preload" href="/assets/js/8.3305ec09.js" as="script"><link rel="prefetch" href="/assets/js/10.87518919.js"><link rel="prefetch" href="/assets/js/11.38972f2e.js"><link rel="prefetch" href="/assets/js/12.34c255af.js"><link rel="prefetch" href="/assets/js/13.5aff14a4.js"><link rel="prefetch" href="/assets/js/14.a81c46cd.js"><link rel="prefetch" href="/assets/js/15.02365660.js"><link rel="prefetch" href="/assets/js/16.35c154ad.js"><link rel="prefetch" href="/assets/js/17.678602d1.js"><link rel="prefetch" href="/assets/js/18.00be67a1.js"><link rel="prefetch" href="/assets/js/19.3e58f9c5.js"><link rel="prefetch" href="/assets/js/20.94b6ca2b.js"><link rel="prefetch" href="/assets/js/21.b4f6a7d2.js"><link rel="prefetch" href="/assets/js/3.2c8ae17f.js"><link rel="prefetch" href="/assets/js/4.6b0ca6fa.js"><link rel="prefetch" href="/assets/js/5.fbfb003a.js"><link rel="prefetch" href="/assets/js/6.a0a96ce6.js"><link rel="prefetch" href="/assets/js/7.ab9b4e1c.js"><link rel="prefetch" href="/assets/js/9.ee8e53b8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fb29a6e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/views/product.html" class="sidebar-link">产品介绍</a></li><li><a href="/views/deployment.html" class="sidebar-link">安装部署</a></li><li><a href="/views/guide.html" class="sidebar-link">配置指南</a></li><li><a href="/views/linkManage.html" class="sidebar-link">连接管理</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>规则引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/views/monitor.html" class="sidebar-link">运维监测</a></li><li><a href="/views/mqtt.html" aria-current="page" class="active sidebar-link">MQTT协议介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/mqtt.html#概览" class="sidebar-link">概览</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#特点" class="sidebar-link">特点</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#应用" class="sidebar-link">应用</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt基于主题-topic-消息路由" class="sidebar-link">MQTT基于主题(Topic)消息路由</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt-v3-1-1协议报文" class="sidebar-link">MQTT V3.1.1协议报文</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt消息qos" class="sidebar-link">MQTT消息QoS</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt会话-clean-session" class="sidebar-link">MQTT会话(Clean Session)</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt连接保活心跳" class="sidebar-link">MQTT连接保活心跳</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt遗愿消息-last-will" class="sidebar-link">MQTT遗愿消息(Last Will)</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt保留消息-retained-message" class="sidebar-link">MQTT保留消息(Retained Message)</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt-websocket连接" class="sidebar-link">MQTT WebSocket连接</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt-与-xmpp-协议对比" class="sidebar-link">MQTT 与 XMPP 协议对比</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt-sn-协议" class="sidebar-link">MQTT-SN 协议</a></li><li class="sidebar-sub-header"><a href="/views/mqtt.html#mqtt-sn-和-mqtt-的区别" class="sidebar-link">MQTT-SN 和 MQTT 的区别</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mqtt协议介绍"><a href="#mqtt协议介绍" class="header-anchor">#</a> MQTT协议介绍</h1> <h2 id="概览"><a href="#概览" class="header-anchor">#</a> 概览</h2> <p>MQTT是一个轻量的发布订阅模式消息传输协议，专门针对低带宽和不稳定网络环境的物联网应用设计。
MQTT官网: <a href="http://mqtt.org/" target="_blank" rel="noopener noreferrer">http://mqtt.org(opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
MQTT V3.1.1协议规范: <a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener noreferrer">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html(opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h2> <ol><li>开放消息协议，简单易实现</li> <li>发布订阅模式，一对多消息发布</li> <li>基于TCP/IP网络连接</li> <li>1字节固定报头，2字节心跳报文，报文结构紧凑</li> <li>消息QoS支持，可靠传输保证</li></ol> <h2 id="应用"><a href="#应用" class="header-anchor">#</a> 应用</h2> <p>MQTT协议广泛应用于物联网、移动互联网、智能硬件、车联网、电力能源等领域。</p> <ol><li>物联网M2M通信，物联网大数据采集</li> <li>Android消息推送，WEB消息推送</li> <li>移动即时消息，例如Facebook Messenger</li> <li>智能硬件、智能家具、智能电器</li> <li>车联网通信，电动车站桩采集</li> <li>智慧城市、远程医疗、远程教育</li> <li>电力、石油与能源等行业市场</li></ol> <h2 id="mqtt基于主题-topic-消息路由"><a href="#mqtt基于主题-topic-消息路由" class="header-anchor">#</a> MQTT基于主题(Topic)消息路由</h2> <p>MQTT协议基于主题(Topic)进行消息路由，主题(Topic)类似URL路径，例如:</p> <div class="language- extra-class"><pre class="language-text"><code>chat/room/1 sensor/10/temperature sensor/+/temperature $SYS/broker/metrics/packets/received $SYS/broker/metrics/# 
</code></pre></div><p>主题(Topic)通过'/'分割层级，支持'+', '#'通配符:</p> <div class="language- extra-class"><pre class="language-text"><code>'+': 表示通配一个层级，例如a/+，匹配a/x, a/y      '#': 表示通配多个层级，例如a/#，匹配a/x, a/b/c/d 
</code></pre></div><p>订阅者与发布者之间通过主题路由消息进行通信，例如采用mosquitto命令行发布订阅消息:</p> <div class="language- extra-class"><pre class="language-text"><code>mosquitto_sub -t a/b/+ -q 1 mosquitto_pub -t a/b/c -m hello -q 1 
</code></pre></div><p>订阅者可以订阅含通配符主题，但发布者不允许向含通配符主题发布消息。</p> <h2 id="mqtt-v3-1-1协议报文"><a href="#mqtt-v3-1-1协议报文" class="header-anchor">#</a> MQTT V3.1.1协议报文</h2> <h3 id="报文结构"><a href="#报文结构" class="header-anchor">#</a> 报文结构</h3> <ul><li>固定报头(Fixed header)</li> <li>可变报头(Variable header)</li> <li>报文有效载荷(Payload)</li></ul> <h3 id="固定报头"><a href="#固定报头" class="header-anchor">#</a> 固定报头</h3> <div class="language- extra-class"><pre class="language-text"><code>+----------+-----+-----+-----+-----+-----+-----+-----+-----+ | Bit      |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  | +----------+-----+-----+-----+-----+-----+-----+-----+-----+ | byte1    |   MQTT Packet type    |         Flags         | +----------+-----------------------+-----------------------+ | byte2... |   Remaining Length                            | +----------+-----------------------------------------------+ 
</code></pre></div><h3 id="报文类型"><a href="#报文类型" class="header-anchor">#</a> 报文类型</h3> <table><thead><tr><th></th> <th></th> <th></th></tr></thead> <tbody><tr><td>类型名称</td> <td>类型值</td> <td>报文说明</td></tr> <tr><td>CONNECT</td> <td>1</td> <td>发起连接</td></tr> <tr><td>CONNACK</td> <td>2</td> <td>连接回执</td></tr> <tr><td>PUBLISH</td> <td>3</td> <td>发布消息</td></tr> <tr><td>PUBACK</td> <td>4</td> <td>发布回执</td></tr> <tr><td>PUBREC</td> <td>5</td> <td>QoS2消息回执</td></tr> <tr><td>PUBREL</td> <td>6</td> <td>QoS2消息释放</td></tr> <tr><td>PUBCOMP</td> <td>7</td> <td>QoS2消息完成</td></tr> <tr><td>SUBSCRIBE</td> <td>8</td> <td>订阅主题</td></tr> <tr><td>SUBACK</td> <td>9</td> <td>订阅回执</td></tr> <tr><td>UNSUBSCRIBE</td> <td>10</td> <td>取消订阅</td></tr> <tr><td>UNSUBACK</td> <td>11</td> <td>取消订阅回执</td></tr> <tr><td>PINGREQ</td> <td>12</td> <td>PING请求</td></tr> <tr><td>PINGRESP</td> <td>13</td> <td>PING响应</td></tr> <tr><td>DISCONNECT</td> <td>14</td> <td>断开连接</td></tr></tbody></table> <h3 id="publish发布消息"><a href="#publish发布消息" class="header-anchor">#</a> PUBLISH发布消息</h3> <p>PUBLISH报文承载客户端与服务器间双向的发布消息。 PUBACK报文用于接收端确认QoS1报文，PUBREC/PUBREL/PUBCOMP报文用于QoS2消息流程。</p> <h3 id="pingreq-pingresp心跳"><a href="#pingreq-pingresp心跳" class="header-anchor">#</a> PINGREQ/PINGRESP心跳</h3> <p>客户端在无报文发送时，按保活周期(KeepAlive)定时向服务端发送PINGREQ心跳报文，服务端响应PINGRESP报文。PINGREQ/PINGRESP报文均2个字节。</p> <h2 id="mqtt消息qos"><a href="#mqtt消息qos" class="header-anchor">#</a> MQTT消息QoS</h2> <p>MQTT发布消息QoS保证不是端到端的，是客户端与服务器之间的。订阅者收到MQTT消息的QoS级别，最终取决于发布消息的QoS和主题订阅的QoS。</p> <table><thead><tr><th>发布消息的 QoS</th> <th>主题订阅的 QoS</th> <th>接收消息的 QoS</th></tr></thead> <tbody><tr><td>0</td> <td>0</td> <td>0</td></tr> <tr><td>0</td> <td>1</td> <td>0</td></tr> <tr><td>0</td> <td>2</td> <td>0</td></tr> <tr><td>1</td> <td>0</td> <td>0</td></tr> <tr><td>1</td> <td>1</td> <td>1</td></tr> <tr><td>1</td> <td>2</td> <td>1</td></tr> <tr><td>2</td> <td>0</td> <td>0</td></tr> <tr><td>2</td> <td>1</td> <td>1</td></tr> <tr><td>2</td> <td>2</td> <td>2</td></tr></tbody></table> <h3 id="qos0消息发布订阅"><a href="#qos0消息发布订阅" class="header-anchor">#</a> Qos0消息发布订阅</h3> <p><img src="/assets/img/12.b0154ea9.png" alt="image.png"></p> <h3 id="qos1消息发布订阅"><a href="#qos1消息发布订阅" class="header-anchor">#</a> Qos1消息发布订阅</h3> <p><img src="/assets/img/13.d9b14b93.png" alt="image.png"></p> <h3 id="qos2消息发布订阅"><a href="#qos2消息发布订阅" class="header-anchor">#</a> Qos2消息发布订阅</h3> <p><img src="/assets/img/14.a909dd3f.png" alt="image.png"></p> <h2 id="mqtt会话-clean-session"><a href="#mqtt会话-clean-session" class="header-anchor">#</a> MQTT会话(Clean Session)</h2> <p>MQTT客户端向服务器发起CONNECT请求时，可以通过'Clean Session'标志设置会话。
'Clean Session'设置为0，表示创建一个持久会话，在客户端断开连接时，会话仍然保持并保存离线消息，直到会话超时注销。
'Clean Session'设置为1，表示创建一个新的临时会话，在客户端断开时，会话自动销毁。</p> <h2 id="mqtt连接保活心跳"><a href="#mqtt连接保活心跳" class="header-anchor">#</a> MQTT连接保活心跳</h2> <p>MQTT客户端向服务器发起CONNECT请求时，通过KeepAlive参数设置保活周期。
客户端在无报文发送时，按KeepAlive周期定时发送2字节的PINGREQ心跳报文，服务端收到PINGREQ报文后，回复2字节的PINGRESP报文。
服务端在1.5个心跳周期内，既没有收到客户端发布订阅报文，也没有收到PINGREQ心跳报文时，主动心跳超时断开客户端TCP连接。
emqx 消息服务器默认按最长 2.5 心跳周期超时设计。</p> <h2 id="mqtt遗愿消息-last-will"><a href="#mqtt遗愿消息-last-will" class="header-anchor">#</a> MQTT遗愿消息(Last Will)</h2> <p>MQTT客户端向服务器端CONNECT请求时，可以设置是否发送遗愿消息(Will Message)标志，和遗愿消息主题(Topic)与内容(Payload)。
MQTT客户端异常下线时(客户端断开前未向服务器发送DISCONNECT消息)，MQTT消息服务器会发布遗愿消息。</p> <h2 id="mqtt保留消息-retained-message"><a href="#mqtt保留消息-retained-message" class="header-anchor">#</a> MQTT保留消息(Retained Message)</h2> <p>MQTT客户端向服务器发布(PUBLISH)消息时，可以设置保留消息(Retained Message)标志。保留消息(Retained Message)会驻留在消息服务器，后来的订阅者订阅主题时仍可以接收该消息。
例如mosquitto命令行发布一条保留消息到主题'a/b/c':</p> <div class="language- extra-class"><pre class="language-text"><code>mosquitto_pub -r -q 1 -t a/b/c -m 'hello' 
</code></pre></div><p>之后连接上来的MQTT客户端订阅主题'a/b/c'时候，仍可收到该消息:</p> <div class="language- extra-class"><pre class="language-text"><code>$ mosquitto_sub -t a/b/c -q 1 hello 
</code></pre></div><p>保留消息(Retained Message)有两种清除方式:</p> <ol><li>客户端向有保留消息的主题发布一个空消息:</li></ol> <div class="language- extra-class"><pre class="language-text"><code>mosquitto_pub -r -q 1 -t a/b/c -m '' 
</code></pre></div><ol><li>消息服务器设置保留消息的超期时间。</li></ol> <h2 id="mqtt-websocket连接"><a href="#mqtt-websocket连接" class="header-anchor">#</a> MQTT WebSocket连接</h2> <p>MQTT协议除支持TCP传输层外，还支持WebSocket作为传输层。通过WebSocket浏览器可以直连MQTT消息服务器，发布订阅模式与其他MQTT客户端通信。
MQTT协议的WebSocket连接，必须采用binary模式，并携带子协议Header:</p> <div class="language- extra-class"><pre class="language-text"><code>Sec-WebSocket-Protocol: mqttv3.1 或 mqttv3.1.1 
</code></pre></div><h2 id="mqtt-与-xmpp-协议对比"><a href="#mqtt-与-xmpp-协议对比" class="header-anchor">#</a> MQTT 与 XMPP 协议对比</h2> <p>MQTT协议设计简单轻量、路由灵活，将在移动互联网物联网消息领域，全面取代PC时代的XMPP协议:</p> <ol><li>MQTT协议一个字节固定报头，两个字节心跳报文，报文体积小编解码容易。XMPP协议基于繁重的XML，报文体积大且交互繁琐。</li> <li>MQTT协议基于主题(Topic)发布订阅模式消息路由，相比XMPP基于JID的点对点消息路由更为灵活。</li> <li>MQTT协议未定义报文内容格式，可以承载JSON、二进制等不同类型报文。XMPP协议采用XML承载报文，二进制必须Base64编码等处理。</li> <li>MQTT协议支持消息收发确认和QoS保证，XMPP主协议并未定义类似机制。MQTT协议有更好的消息可靠性保证。</li></ol> <h2 id="mqtt-sn-协议"><a href="#mqtt-sn-协议" class="header-anchor">#</a> MQTT-SN 协议</h2> <p>MQTT-SN 协议是 MQTT 的直系亲属，它使用 UDP 进行通信，标准的端口是1884。MQTT-SN 的主要目的是为了适应受限的设备和网络，比如一些传感器，只有很小的内存和 CPU，TCP 对于这些设备来说非常奢侈。还有一些网络，比如 ZIGBEE，报文的长度在300字节以下，无法承载太大的数据包。所以 MQTT-SN 的数据包更小巧。
MQTT-SN 的官方标准下载地址: <a href="http://mqtt.org/new/wp-content/uploads/2009/06/MQTT-SN_spec_v1.2.pdf" target="_blank" rel="noopener noreferrer">http://mqtt.org/new/wp-content/uploads/2009/06/MQTT-SN_spec_v1.2.pdf(opens new window)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="mqtt-sn-和-mqtt-的区别"><a href="#mqtt-sn-和-mqtt-的区别" class="header-anchor">#</a> MQTT-SN 和 MQTT 的区别</h2> <p>MQTT-SN 的信令和 MQTT 大部分都相同，比如都有 Will, 都有 Connect/Subscribe/Publish 命令.
MQTT-SN 最大的不同是，Topic 使用 TopicId 来代替，而 TopicId 是一个16比特的数字。每一个数字对应一个 Topic, 设备和云端需要使用 REGISTER 命令映射 TopicId 和 Topic 的对应关系。
MQTT-SN 可以随时更改 Will 的内容, 甚至可以取消. 而 MQTT 只允许在 CONNECT 时设定 Will 的内容, 而且不允许更改.
MQTT-SN 的网络中有网关这种设备，它负责把 MQTT-SN 转换成 MQTT，和云端的 MQTT Broker 通信. MQTT-SN 的协议支持自动发现网关的功能。
MQTT-SN 还支持设备的睡眠功能，如果设备进入睡眠状态，无法接收 UDP 数据，网关将把下行的 PUBLISH 消息缓存起来，直到设备苏醒后再传送。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/views/monitor.html" class="prev">
        运维监测
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3c98569e.js" defer></script><script src="/assets/js/2.6c5bc1d3.js" defer></script><script src="/assets/js/8.3305ec09.js" defer></script>
  </body>
</html>
